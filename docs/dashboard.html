<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Legal Services Portal</title>
    <link rel="stylesheet" href="style.css">
    <script>
        (function() {
            var auth = localStorage.getItem('legal-portal-auth');
            var authTime = localStorage.getItem('legal-portal-auth-time');
            var maxAge = 24 * 60 * 60 * 1000;
            if (auth !== 'authenticated' || !authTime || (Date.now() - parseInt(authTime)) > maxAge) {
                window.location.href = 'index.html';
            }
        })();
    </script>
</head>
<body>
    <div class="app-shell">
        <!-- Left Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <div class="sidebar-logo-icon">
                        <svg viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
                    </div>
                    Legal Portal
                </div>
            </div>

            <!-- Practice Selector -->
            <div class="practice-selector">
                <label>Practice Area</label>
                <select class="practice-select" id="practiceSelect" onchange="switchPractice(this.value)">
                    <option value="immigration">Immigration</option>
                    <option value="contracts">Contracts</option>
                    <option value="estate">Estate Planning</option>
                    <option value="general">General</option>
                </select>
            </div>

            <!-- Workflow Steps -->
            <nav class="workflow-nav">
                <div class="workflow-label">Workflow</div>
                <ul class="workflow-steps" id="workflowSteps">
                    <!-- Populated by JavaScript -->
                </ul>
            </nav>

            <!-- Sidebar Footer -->
            <div class="sidebar-footer">
                <a href="about.html">How It Works</a>
                <a href="#" onclick="logout(); return false;">Sign Out</a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Bar -->
            <header class="top-bar">
                <span class="top-bar-title" id="currentStepTitle">Immigration — Intake</span>
                <div class="top-bar-actions">
                    <a href="about.html">Help</a>
                </div>
            </header>

            <!-- Content Area -->
            <div class="content-container" id="contentArea">
                <!-- Tool content loads here -->
            </div>
        </main>
    </div>

    <script>
        // Practice workflows
        const workflows = {
            immigration: {
                label: 'Immigration',
                steps: [
                    { id: 'intake', name: 'Intake', icon: '1', page: 'intake.html' },
                    { id: 'documents', name: 'Documents', icon: '2', page: 'checklist.html' },
                    { id: 'forms', name: 'Forms', icon: '3', page: 'forms.html' },
                    { id: 'summary', name: 'Summary', icon: '4', page: 'summary.html' },
                    { id: 'file', name: 'File', icon: '5', page: 'deadlines.html' }
                ]
            },
            contracts: {
                label: 'Contracts',
                steps: [
                    { id: 'upload', name: 'Upload', icon: '1', page: null },
                    { id: 'compare', name: 'Compare', icon: '2', page: 'redline.html' },
                    { id: 'review', name: 'Review', icon: '3', page: null },
                    { id: 'export', name: 'Export', icon: '4', page: null }
                ]
            },
            estate: {
                label: 'Estate Planning',
                steps: [
                    { id: 'client', name: 'Client Info', icon: '1', page: null },
                    { id: 'assets', name: 'Assets', icon: '2', page: null },
                    { id: 'documents', name: 'Documents', icon: '3', page: null },
                    { id: 'review', name: 'Review', icon: '4', page: null }
                ]
            },
            general: {
                label: 'General',
                steps: [
                    { id: 'intake', name: 'Intake', icon: '1', page: 'intake.html' },
                    { id: 'documents', name: 'Documents', icon: '2', page: 'checklist.html' },
                    { id: 'deadlines', name: 'Deadlines', icon: '3', page: 'deadlines.html' }
                ]
            }
        };

        let currentPractice = localStorage.getItem('legal-portal-practice') || 'immigration';
        let currentStep = localStorage.getItem('legal-portal-step') || 'intake';

        // Initialize
        document.getElementById('practiceSelect').value = currentPractice;
        renderWorkflow();
        loadStep(currentStep);

        function switchPractice(practice) {
            currentPractice = practice;
            localStorage.setItem('legal-portal-practice', practice);
            currentStep = workflows[practice].steps[0].id;
            localStorage.setItem('legal-portal-step', currentStep);
            renderWorkflow();
            loadStep(currentStep);
        }

        function renderWorkflow() {
            const workflow = workflows[currentPractice];
            const container = document.getElementById('workflowSteps');

            container.innerHTML = workflow.steps.map(step => `
                <li class="workflow-step ${step.id === currentStep ? 'active' : ''}"
                    onclick="loadStep('${step.id}')"
                    data-step="${step.id}">
                    <span class="step-indicator">
                        <span class="step-number">${step.icon}</span>
                    </span>
                    <span>${step.name}</span>
                </li>
            `).join('');
        }

        function loadStep(stepId) {
            currentStep = stepId;
            localStorage.setItem('legal-portal-step', stepId);

            // Update active state in sidebar
            document.querySelectorAll('.workflow-step').forEach(el => {
                el.classList.toggle('active', el.dataset.step === stepId);
            });

            // Update top bar title
            const workflow = workflows[currentPractice];
            const step = workflow.steps.find(s => s.id === stepId);
            document.getElementById('currentStepTitle').textContent =
                `${workflow.label} — ${step.name}`;

            // Load content
            const contentArea = document.getElementById('contentArea');

            if (step.page) {
                // Load actual tool content inline
                loadToolContent(step, contentArea);
            } else {
                // Placeholder for unbuilt tools
                contentArea.innerHTML = `
                    <div class="page-header">
                        <h1>${step.name}</h1>
                        <p>This tool is coming soon.</p>
                    </div>
                    <div class="card">
                        <div class="empty-state">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <rect x="3" y="3" width="18" height="18" rx="2"/>
                                <path d="M9 9h6M9 12h6M9 15h4"/>
                            </svg>
                            <h3>${step.name}</h3>
                            <p>This feature is under development.</p>
                        </div>
                    </div>
                `;
            }
        }

        function loadToolContent(step, container) {
            // For now, show tool description and link to full page
            const toolDescriptions = {
                intake: {
                    title: 'Client Intake',
                    description: 'Collect client information with a guided questionnaire. Data flows to other tools automatically.',
                    actions: [
                        { label: 'Start New Intake', primary: true, action: "window.location.href='intake.html'" },
                        { label: 'View Existing Clients', action: "showClients()" }
                    ]
                },
                documents: {
                    title: 'Document Checklist',
                    description: 'Track required documents for each case. Generate checklists based on case type.',
                    actions: [
                        { label: 'Open Checklist', primary: true, action: "window.location.href='checklist.html'" }
                    ]
                },
                forms: {
                    title: 'Form Assembly',
                    description: 'Auto-populate USCIS forms using intake data. Review and export for filing.',
                    actions: [
                        { label: 'Assemble Forms', primary: true, action: "window.location.href='forms.html'" }
                    ]
                },
                summary: {
                    title: 'Case Summary',
                    description: 'Generate comprehensive case summaries for attorney review.',
                    actions: [
                        { label: 'Generate Summary', primary: true, action: "window.location.href='summary.html'" }
                    ]
                },
                file: {
                    title: 'Deadlines & Filing',
                    description: 'Track critical deadlines and filing dates. Never miss a deadline.',
                    actions: [
                        { label: 'View Deadlines', primary: true, action: "window.location.href='deadlines.html'" }
                    ]
                },
                compare: {
                    title: 'Contract Comparison',
                    description: 'Compare two documents and identify differences. Generate redlines.',
                    actions: [
                        { label: 'Compare Documents', primary: true, action: "window.location.href='redline.html'" }
                    ]
                },
                deadlines: {
                    title: 'Deadline Tracker',
                    description: 'Track all case deadlines in one place.',
                    actions: [
                        { label: 'View Deadlines', primary: true, action: "window.location.href='deadlines.html'" }
                    ]
                }
            };

            const tool = toolDescriptions[step.id] || {
                title: step.name,
                description: 'Tool description not available.',
                actions: []
            };

            // Check for existing clients
            const clients = JSON.parse(localStorage.getItem('legal-portal-intakes') || '[]');

            let clientsSection = '';
            if (step.id === 'intake' && clients.length > 0) {
                clientsSection = `
                    <div class="card" style="margin-top: 16px;">
                        <div class="card-header">
                            <h3>Recent Clients</h3>
                        </div>
                        <div style="margin: -8px -8px 0;">
                            ${clients.slice(0, 5).map(client => `
                                <div style="padding: 12px 16px; border-bottom: 1px solid var(--border-light); display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="font-weight: 500;">${client.firstName || ''} ${client.lastName || 'Unnamed'}</div>
                                        <div style="font-size: 13px; color: var(--text-muted);">${client.caseType || 'No case type'}</div>
                                    </div>
                                    <span class="badge badge-pending">Draft</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            container.innerHTML = `
                <div class="page-header">
                    <h1>${tool.title}</h1>
                    <p>${tool.description}</p>
                </div>

                <div class="card">
                    <div style="display: flex; gap: 12px;">
                        ${tool.actions.map(action => `
                            <button class="btn ${action.primary ? 'btn-primary' : 'btn-secondary'}"
                                    onclick="${action.action}">
                                ${action.label}
                            </button>
                        `).join('')}
                    </div>
                </div>

                ${clientsSection}
            `;
        }

        function showClients() {
            const clients = JSON.parse(localStorage.getItem('legal-portal-intakes') || '[]');
            const container = document.getElementById('contentArea');

            if (clients.length === 0) {
                container.innerHTML = `
                    <div class="page-header">
                        <h1>Clients</h1>
                        <p>No clients yet. Start an intake to add your first client.</p>
                    </div>
                    <div class="card">
                        <div class="empty-state">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                                <circle cx="9" cy="7" r="4"/>
                            </svg>
                            <h3>No Clients</h3>
                            <p>Start a new intake to add your first client.</p>
                            <button class="btn btn-primary" onclick="window.location.href='intake.html'">
                                Start New Intake
                            </button>
                        </div>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="page-header">
                        <h1>Clients</h1>
                        <p>${clients.length} client${clients.length !== 1 ? 's' : ''} in system.</p>
                    </div>
                    <div class="card" style="padding: 0; overflow: hidden;">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Case Type</th>
                                    <th>Status</th>
                                    <th>Intake Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${clients.map(client => `
                                    <tr>
                                        <td style="font-weight: 500;">${client.firstName || ''} ${client.lastName || 'Unnamed'}</td>
                                        <td>${formatCaseType(client.caseType)}</td>
                                        <td><span class="badge badge-pending">Draft</span></td>
                                        <td>${client.meta?.intakeDate ? new Date(client.meta.intakeDate).toLocaleDateString() : '—'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    <div style="margin-top: 16px;">
                        <button class="btn btn-primary" onclick="window.location.href='intake.html'">
                            Start New Intake
                        </button>
                    </div>
                `;
            }
        }

        function formatCaseType(type) {
            const types = {
                'asylum': 'Asylum',
                'family': 'Family-Based',
                'naturalization': 'Naturalization',
                'u_visa': 'U Visa',
                't_visa': 'T Visa',
                'vawa': 'VAWA',
                'tps': 'TPS',
                'daca': 'DACA',
                'work_permit': 'Work Permit',
                'removal_defense': 'Removal Defense'
            };
            return types[type] || type || '—';
        }

        function logout() {
            localStorage.removeItem('legal-portal-auth');
            localStorage.removeItem('legal-portal-auth-time');
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>
