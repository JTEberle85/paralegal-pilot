<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Legal Services Portal - Deadline Tracker</title>
    <link rel="stylesheet" href="style.css">
    <script>
        (function() {
            var auth = localStorage.getItem('legal-portal-auth');
            var authTime = localStorage.getItem('legal-portal-auth-time');
            var maxAge = 24 * 60 * 60 * 1000;
            if (auth !== 'authenticated' || !authTime || (Date.now() - parseInt(authTime)) > maxAge) {
                window.location.href = 'index.html';
            }
        })();
    </script>
    <style>
        .deadline-card {
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 12px;
            background: var(--bg-white);
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .deadline-card.critical { border-left: 3px solid var(--danger); background: #FEF2F2; }
        .deadline-card.high { border-left: 3px solid var(--warning); background: #FFFBEB; }
        .deadline-card.complete { border-left: 3px solid var(--success); background: #ECFDF5; opacity: 0.8; }
        .deadline-date { text-align: center; min-width: 60px; }
        .deadline-date .day { font-size: 24px; font-weight: 600; color: var(--accent); }
        .deadline-date .month { font-size: 10px; color: var(--text-muted); text-transform: uppercase; }
        .deadline-content { flex: 1; }
        .deadline-title { font-weight: 500; margin-bottom: 4px; }
        .deadline-meta { font-size: 13px; color: var(--text-muted); }
        .deadline-countdown { text-align: right; min-width: 70px; }
        .countdown-number { font-size: 20px; font-weight: 600; }
        .countdown-number.danger { color: var(--danger); }
        .countdown-number.warning { color: var(--warning); }
        .countdown-number.ok { color: var(--success); }
        .countdown-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; }
        .section-title { display: flex; align-items: center; gap: 10px; margin: 28px 0 16px 0; }
        .section-title:first-of-type { margin-top: 0; }
        .section-title h3 { margin: 0; font-size: 16px; }
        .section-count { background: var(--accent); color: white; border-radius: 10px; padding: 2px 10px; font-size: 11px; font-weight: 500; }
        .quick-add { background: var(--bg-gray); border-radius: 6px; padding: 20px; margin-bottom: 24px; }
    </style>
</head>
<body>
    <div class="app-shell">
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="#" onclick="goToLanding(); return false;" class="sidebar-logo" style="text-decoration: none; color: inherit;">
                    <div class="sidebar-logo-icon"><svg viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg></div>
                    Legal Portal
                </a>
            </div>
            <div class="practice-selector">
                <label>Practice Area</label>
                <select class="practice-select" id="practiceSelect" onchange="switchPractice(this.value)">
                    <option value="immigration" selected>Immigration</option>
                    <option value="contracts">Contracts</option>
                    <option value="estate">Estate Planning</option>
                    <option value="general">General</option>
                </select>
            </div>
            <nav class="workflow-nav">
                <div class="workflow-label">Workflow</div>
                <ul class="workflow-steps">
                    <li class="workflow-step" onclick="window.location.href='intake.html'"><span class="step-indicator"><span class="step-number">1</span></span><span>Intake</span></li>
                    <li class="workflow-step" onclick="window.location.href='checklist.html'"><span class="step-indicator"><span class="step-number">2</span></span><span>Documents</span></li>
                    <li class="workflow-step" onclick="window.location.href='forms.html'"><span class="step-indicator"><span class="step-number">3</span></span><span>Forms</span></li>
                    <li class="workflow-step" onclick="window.location.href='summary.html'"><span class="step-indicator"><span class="step-number">4</span></span><span>Summary</span></li>
                    <li class="workflow-step active" onclick="window.location.href='deadlines.html'"><span class="step-indicator"><span class="step-number">5</span></span><span>File</span></li>
                </ul>
            </nav>
            <div class="sidebar-footer">
                <a href="about.html">How It Works</a>
                <a href="#" onclick="logout(); return false;">Sign Out</a>
            </div>
        </aside>

        <main class="main-content">
            <header class="top-bar">
                <span class="top-bar-title">Immigration â€” Deadlines</span>
                <div class="top-bar-actions"><a href="dashboard.html">Dashboard</a></div>
            </header>

            <div class="content-container wide">
                <div class="draft-notice"><strong>VERIFY ALL DEADLINES WITH ATTORNEY</strong></div>

                <div class="quick-add">
                    <h3 style="margin: 0 0 16px 0;">Add Deadline</h3>
                    <div class="form-row">
                        <div class="form-group"><label class="form-label">Type</label><select class="form-select" id="deadlineType" onchange="updateDeadlineForm()"><option value="custom">Custom</option><option value="asylum_1year">Asylum 1-Year</option><option value="rfe_response">RFE Response</option><option value="court_hearing">Court Hearing</option></select></div>
                        <div class="form-group"><label class="form-label">Client</label><input type="text" class="form-input" id="clientName"></div>
                    </div>
                    <div id="asylum1YearFields" style="display: none;">
                        <div class="alert alert-warning" style="margin-bottom: 16px;">1 year from last entry date</div>
                        <div class="form-group"><label class="form-label">Entry Date</label><input type="date" class="form-input" id="entryDate"></div>
                    </div>
                    <div id="rfeFields" style="display: none;">
                        <div class="form-row">
                            <div class="form-group"><label class="form-label">RFE Date</label><input type="date" class="form-input" id="rfeDate"></div>
                            <div class="form-group"><label class="form-label">Days</label><select class="form-select" id="rfeDays"><option value="87">87</option><option value="30">30</option></select></div>
                        </div>
                    </div>
                    <div id="customFields">
                        <div class="form-row">
                            <div class="form-group"><label class="form-label">Title</label><input type="text" class="form-input" id="deadlineTitle"></div>
                            <div class="form-group"><label class="form-label">Due Date</label><input type="date" class="form-input" id="dueDate"></div>
                        </div>
                        <div class="form-group"><label class="form-label">Priority</label><select class="form-select" id="priority"><option value="critical">Critical</option><option value="high">High</option><option value="medium" selected>Medium</option></select></div>
                    </div>
                    <div class="form-group"><label class="form-label">Notes</label><textarea class="form-textarea" id="deadlineNotes" style="min-height: 60px;"></textarea></div>
                    <button class="btn btn-primary" onclick="addDeadline()">Add Deadline</button>
                </div>

                <div class="section-title"><h3 style="color: var(--danger);">Critical</h3><span class="section-count" id="criticalCount" style="background: var(--danger);">0</span></div>
                <div id="criticalDeadlines"><p class="text-muted">No critical deadlines.</p></div>

                <div class="section-title"><h3>Upcoming (30 days)</h3><span class="section-count" id="upcomingCount">0</span></div>
                <div id="upcomingDeadlines"><p class="text-muted">No upcoming deadlines.</p></div>

                <div class="section-title"><h3>Later</h3><span class="section-count" id="laterCount">0</span></div>
                <div id="laterDeadlines"><p class="text-muted">No later deadlines.</p></div>

                <div class="section-title"><h3>Completed</h3><span class="section-count" id="completedCount">0</span></div>
                <div id="completedDeadlines"><p class="text-muted">No completed deadlines.</p></div>
            </div>
        </main>
    </div>

    <script>
        let deadlines = JSON.parse(localStorage.getItem('legal-portal-deadlines') || '[]');

        function updateDeadlineForm() {
            const type = document.getElementById('deadlineType').value;
            document.getElementById('asylum1YearFields').style.display = type === 'asylum_1year' ? 'block' : 'none';
            document.getElementById('rfeFields').style.display = type === 'rfe_response' ? 'block' : 'none';
            document.getElementById('customFields').style.display = (type === 'custom' || type === 'court_hearing') ? 'block' : 'none';
        }

        function addDeadline() {
            const type = document.getElementById('deadlineType').value;
            const clientName = document.getElementById('clientName').value;
            const notes = document.getElementById('deadlineNotes').value;
            let deadline = { id: Date.now().toString(), type, clientName, notes, status: 'pending', createdDate: new Date().toISOString() };

            if (type === 'asylum_1year') {
                const entry = document.getElementById('entryDate').value;
                if (!entry) { alert('Enter entry date.'); return; }
                const due = new Date(entry); due.setFullYear(due.getFullYear() + 1);
                deadline.title = 'Asylum 1-Year Deadline';
                deadline.dueDate = due.toISOString().split('T')[0];
                deadline.priority = 'critical';
            } else if (type === 'rfe_response') {
                const rfe = document.getElementById('rfeDate').value;
                const days = parseInt(document.getElementById('rfeDays').value);
                if (!rfe) { alert('Enter RFE date.'); return; }
                const due = new Date(rfe); due.setDate(due.getDate() + days);
                deadline.title = `RFE Response (${days} days)`;
                deadline.dueDate = due.toISOString().split('T')[0];
                deadline.priority = 'critical';
            } else {
                const title = document.getElementById('deadlineTitle').value;
                const dueDate = document.getElementById('dueDate').value;
                if (!title || !dueDate) { alert('Enter title and date.'); return; }
                deadline.title = title;
                deadline.dueDate = dueDate;
                deadline.priority = document.getElementById('priority').value;
            }

            deadlines.push(deadline);
            saveAndRender();
            document.getElementById('clientName').value = '';
            document.getElementById('deadlineNotes').value = '';
            document.getElementById('deadlineTitle').value = '';
            document.getElementById('dueDate').value = '';
        }

        function saveAndRender() {
            localStorage.setItem('legal-portal-deadlines', JSON.stringify(deadlines));
            renderDeadlines();
        }

        function getDaysRemaining(date) {
            const due = new Date(date); due.setHours(0,0,0,0);
            const today = new Date(); today.setHours(0,0,0,0);
            return Math.ceil((due - today) / (1000*60*60*24));
        }

        function renderCard(d) {
            const days = getDaysRemaining(d.dueDate);
            const due = new Date(d.dueDate);
            const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
            let cardClass = d.priority || 'medium';
            if (d.status === 'complete') cardClass = 'complete';
            let countdownClass = days <= 7 ? 'danger' : days <= 14 ? 'warning' : 'ok';
            return `<div class="deadline-card ${cardClass}">
                <div class="deadline-date"><div class="day">${due.getDate()}</div><div class="month">${months[due.getMonth()]}</div></div>
                <div class="deadline-content"><div class="deadline-title">${d.title}</div><div class="deadline-meta">${d.clientName || ''} ${d.notes || ''}</div></div>
                <div class="deadline-countdown"><div class="countdown-number ${countdownClass}">${days < 0 ? 'PAST' : days}</div><div class="countdown-label">${days < 0 ? 'overdue' : 'days'}</div></div>
                <div>${d.status !== 'complete' ? `<button class="btn btn-sm btn-secondary" onclick="markComplete('${d.id}')">Done</button>` : '<span class="badge badge-complete">Done</span>'}</div>
            </div>`;
        }

        function renderDeadlines() {
            const critical = [], upcoming = [], later = [], completed = [];
            deadlines.forEach(d => {
                const days = getDaysRemaining(d.dueDate);
                if (d.status === 'complete' || days < 0) completed.push(d);
                else if (days <= 7 || d.priority === 'critical') critical.push(d);
                else if (days <= 30) upcoming.push(d);
                else later.push(d);
            });
            const sort = (a,b) => new Date(a.dueDate) - new Date(b.dueDate);
            critical.sort(sort); upcoming.sort(sort); later.sort(sort);

            document.getElementById('criticalCount').textContent = critical.length;
            document.getElementById('upcomingCount').textContent = upcoming.length;
            document.getElementById('laterCount').textContent = later.length;
            document.getElementById('completedCount').textContent = completed.length;

            document.getElementById('criticalDeadlines').innerHTML = critical.length ? critical.map(renderCard).join('') : '<p class="text-muted">No critical deadlines.</p>';
            document.getElementById('upcomingDeadlines').innerHTML = upcoming.length ? upcoming.map(renderCard).join('') : '<p class="text-muted">No upcoming deadlines.</p>';
            document.getElementById('laterDeadlines').innerHTML = later.length ? later.map(renderCard).join('') : '<p class="text-muted">No later deadlines.</p>';
            document.getElementById('completedDeadlines').innerHTML = completed.length ? completed.map(renderCard).join('') : '<p class="text-muted">No completed deadlines.</p>';
        }

        function markComplete(id) { const d = deadlines.find(x => x.id === id); if (d) { d.status = 'complete'; saveAndRender(); } }
        function switchPractice(p) { localStorage.setItem('legal-portal-practice', p); window.location.href = 'dashboard.html'; }
        function goToLanding() {
            localStorage.removeItem('legal-portal-practice');
            localStorage.removeItem('legal-portal-step');
            window.location.href = 'dashboard.html';
        }
        function logout() { localStorage.removeItem('legal-portal-auth'); localStorage.removeItem('legal-portal-auth-time'); window.location.href = 'index.html'; }
        renderDeadlines();
    </script>
</body>
</html>
